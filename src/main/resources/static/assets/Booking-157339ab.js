import{_ as re,u as ue,r as L,l as ie,b as f,m as ce,k as de,n as me,d,o as i,c as m,e as t,h as F,w as n,j as v,f as s,t as c,p as pe,q as ge,E as y,i as k,F as fe,g as ve,s as ke,v as U,x as ye,y as be}from"./index-27530dd5.js";const he={class:"page-container"},_e={class:"booking-container"},Ie={class:"login-actions"},Ce={class:"room-option"},Te={class:"room-price"},Ve={key:0,class:"member-info"},we={class:"member-level"},xe={key:0,class:"discount-info"},Me={key:0,class:"member-only"},Se={key:0,class:"member-only"},Ne={class:"booking-summary"},De={class:"booking-summary-item"},Oe={class:"booking-summary-item"},Ae={class:"booking-summary-item"},Be={key:0,class:"booking-summary-item"},Le={class:"discount"},Fe={class:"booking-summary-item total"},Ue={key:1,class:"booking-summary-item"},Pe={class:"deposit"},qe={key:2,class:"booking-summary-item"},Re={class:"points"},$e={class:"booking-benefits"},Ee={key:0,class:"benefit-item"},ze={key:1,class:"benefit-item"},He={key:2,class:"benefit-item"},je={class:"benefit-item"},Je={__name:"Booking",setup(Ge){const V=ue(),C=L(null),M=L(!1),K=ie(),u=f(()=>localStorage.getItem("userToken")!==null),Q=f(()=>localStorage.getItem("userName")||""),h=f(()=>localStorage.getItem("userLevel")||"普通用户"),o=ce({checkIn:"",checkOut:"",roomType:"",roomCount:1,contactName:"",phone:"",remarks:"",paymentMethod:1,depositType:2});u.value&&(o.contactName=Q.value,o.phone="13812345678");const w=L([]),W={checkIn:[{required:!0,message:"请选择入住日期",trigger:"change"}],checkOut:[{required:!0,message:"请选择退房日期",trigger:"change"}],roomType:[{required:!0,message:"请选择房间类型",trigger:"change"}],contactName:[{required:!0,message:"请输入联系人姓名",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号码",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],paymentMethod:[{required:!0,message:"请选择支付方式",trigger:"change"}]},S=f(()=>{if(!o.roomType)return 0;const l=w.value.find(e=>e.id===o.roomType);return l?l.price:0}),N=f(()=>{if(!o.checkIn||!o.checkOut)return 0;const l=new Date(o.checkIn),e=new Date(o.checkOut);return Math.ceil((e-l)/(24*60*60*1e3))}),D=()=>({普通用户:1,铜牌会员:.98,银牌会员:.95,金牌会员:.9,钻石会员:.85})[h.value]||1,X=()=>({普通用户:0,铜牌会员:1,银牌会员:1.2,金牌会员:1.5,钻石会员:2})[h.value]||0,P=f(()=>["银牌会员","金牌会员","钻石会员"].includes(h.value)),q=f(()=>["铜牌会员","银牌会员","金牌会员","钻石会员"].includes(h.value)),O=f(()=>{if(!u.value)return 0;const l=D();return l>=1?0:S.value*N.value*o.roomCount*(1-l)}),R=f(()=>{if(!u.value)return 0;const l=X();return l<=0?0:Math.floor(b.value*l)}),b=f(()=>S.value*N.value*o.roomCount-O.value),Y=f(()=>{if(o.paymentMethod!==1)return 0;switch(o.depositType){case 1:return b.value;case 2:return b.value*.3;case 3:return 0;default:return b.value*.3}}),$=()=>{},Z=()=>{},E=l=>l<new Date(new Date().setHours(0,0,0,0)),ee=l=>o.checkIn?l<=o.checkIn:E(l),z=()=>{o.checkIn&&o.checkOut&&o.checkOut<=o.checkIn&&(o.checkOut="",y.warning("退房日期必须晚于入住日期"))},H=async()=>{if(console.log("[fillContactInfo] Checking login status...",u.value),u.value){const l=K.userId;if(console.log("[fillContactInfo] User is logged in, userId:",l),l)try{console.log("[fillContactInfo] Fetching user info for ID:",l);const e=await pe.getUserInfo(l);console.log("[fillContactInfo] API response:",e),e.success&&e.data?(o.contactName=e.data.name||"",o.phone=e.data.phone||"",console.log(`[fillContactInfo] Filled contact info: Name=${o.contactName}, Phone=${o.phone}`)):console.warn("[fillContactInfo] Failed to fetch user info or data missing:",e==null?void 0:e.message)}catch(e){console.error("[fillContactInfo] Error fetching user info:",e)}else console.warn("[fillContactInfo] User ID not found in auth store.")}else console.log("[fillContactInfo] User is not logged in.")},j=async()=>{var l,e;try{const p=localStorage.getItem("userId"),A=localStorage.getItem("userToken");if(!p||!A){y.error("登录信息无效，请重新登录");return}M.value=!0;const x={userId:parseInt(p),roomType:o.roomType,checkIn:o.checkIn,checkOut:o.checkOut,roomCount:o.roomCount,contactName:o.contactName,phone:o.phone,remarks:o.remarks,totalAmount:b.value},r=await ye.createReservation(x);if(r.success){if(console.log("预订已成功提交到后端，预订ID:",((l=r.data)==null?void 0:l.reservationId)||r.reservationId),u.value)try{const g=await be.getMemberInfo(p);if(g&&g.success&&g.data){const _=g.data,B=localStorage.getItem("userLevel");localStorage.setItem("userLevel",_.memberLevel||"普通用户"),localStorage.setItem("userPoints",String(_.points||0)),localStorage.setItem("userTotalSpent",String(_.totalSpent||0));const I=localStorage.getItem("userLevel");I&&B!==I&&y({type:"success",message:`恭喜您！会员等级已升级为 ${_.memberLevel}！`,duration:5e3,showClose:!0})}else console.error("获取或处理会员信息失败:",(g==null?void 0:g.message)||"响应结构不符")}catch(g){console.error("更新会员信息失败:",g)}U.alert(`预订已成功提交！预订单号：${((e=r.data)==null?void 0:e.reservationId)||r.reservationId}`,"预订成功",{confirmButtonText:"确定",callback:()=>{J(),V.push({path:"/user",query:{tab:"bookings"}})}})}else y.error(r.message||"预订提交失败，请稍后重试")}catch(p){console.error("预订失败:",p),y.error(p.message||"预订提交失败，请稍后重试")}finally{M.value=!1}},oe=async()=>{let l=!1;if(C.value)try{await C.value.validate(),l=!0}catch(e){console.log("Form validation failed:",e),l=!1}if(!l){y.warning("请完成所有必填信息");return}if(!u.value){U.confirm("预订需要登录，是否前往登录页面？","提示",{confirmButtonText:"去登录",cancelButtonText:"取消",type:"info"}).then(()=>{localStorage.setItem("tempBookingData",JSON.stringify({checkIn:o.checkIn,checkOut:o.checkOut,roomType:o.roomType,roomCount:o.roomCount,contactName:o.contactName,phone:o.phone,remarks:o.remarks})),V.push({path:"/login",query:{redirect:"/booking"}})}).catch(()=>{});return}o.paymentMethod===1?U.confirm(`确认支付订单总额 ¥${b.value.toFixed(2)} 吗？`,"模拟支付",{confirmButtonText:"确认支付",cancelButtonText:"取消",type:"warning"}).then(async()=>{await j()}).catch(()=>{console.log("用户取消支付"),y.info("支付已取消")}):await j()},te=()=>{V.push({path:"/login",query:{redirect:"/booking"}})},le=()=>{V.push({path:"/register",query:{redirect:"/booking"}})},J=()=>{C.value&&C.value.resetFields()},se=async()=>{try{const l=await ge.getAllRoomTypes();console.log("API response:",l),l&&l.success&&Array.isArray(l.data)?(w.value=l.data.map(e=>({...e,price:e.basePrice})),console.log("Processed room types:",w.value)):(console.error("获取房型数据格式不正确:",l),y.error("获取房型数据格式不正确"))}catch(l){console.error("获取房型列表失败:",l),y.error(l.message||"获取房型列表失败，请稍后再试")}};return de(()=>{se(),H()}),me(u,l=>{console.log("[watch isLoggedIn] Login status changed to:",l),l&&H()}),(l,e)=>{const p=d("el-button"),A=d("el-alert"),x=d("el-date-picker"),r=d("el-form-item"),g=d("el-option"),_=d("el-select"),B=d("el-input-number"),I=d("el-input"),T=d("el-radio"),G=d("el-radio-group"),ne=d("el-form"),ae=d("el-card");return i(),m("div",he,[e[36]||(e[36]=t("div",{class:"background-image"},null,-1)),t("div",_e,[e[35]||(e[35]=t("div",{class:"booking-header"},[t("h1",null,"尊享豪华客房预订"),t("p",null,"为您的优雅旅程精心呈现尊贵入住体验")],-1)),u.value?v("",!0):(i(),F(A,{key:0,title:"尊享会员礼遇",type:"info",description:"登录会员账号可享受尊贵折扣、积分奖励及更多专属礼遇","show-icon":"",closable:!1,class:"login-alert luxury-alert"},{default:n(()=>[t("div",Ie,[s(p,{type:"primary",size:"small",onClick:te,class:"luxury-btn"},{default:n(()=>e[9]||(e[9]=[k("登录")])),_:1}),s(p,{size:"small",onClick:le,class:"luxury-outline-btn"},{default:n(()=>e[10]||(e[10]=[k("注册新账号")])),_:1})])]),_:1})),s(ae,{class:"booking-form luxury-glass-effect"},{default:n(()=>[e[28]||(e[28]=t("div",{class:"form-decoration left"},null,-1)),e[29]||(e[29]=t("div",{class:"form-decoration right"},null,-1)),s(ne,{model:o,rules:W,ref_key:"bookingFormRef",ref:C,"label-width":"120px","label-position":"left",class:"elegant-form"},{default:n(()=>[e[25]||(e[25]=t("h3",{class:"form-section-title"},[t("span",{class:"section-icon"}),k("房间信息")],-1)),s(r,{label:"入住日期",prop:"checkIn"},{default:n(()=>[s(x,{modelValue:o.checkIn,"onUpdate:modelValue":e[0]||(e[0]=a=>o.checkIn=a),type:"date",placeholder:"选择入住日期","disabled-date":E,onChange:z,class:"luxury-date-picker"},null,8,["modelValue"])]),_:1}),s(r,{label:"退房日期",prop:"checkOut"},{default:n(()=>[s(x,{modelValue:o.checkOut,"onUpdate:modelValue":e[1]||(e[1]=a=>o.checkOut=a),type:"date",placeholder:"选择退房日期","disabled-date":ee,onChange:z,class:"custom-date-picker"},null,8,["modelValue"])]),_:1}),s(r,{label:"房间类型",prop:"roomType"},{default:n(()=>[s(_,{modelValue:o.roomType,"onUpdate:modelValue":e[2]||(e[2]=a=>o.roomType=a),placeholder:"请选择房间类型",class:"custom-select",onChange:$},{default:n(()=>[(i(!0),m(fe,null,ve(w.value,a=>(i(),F(g,{key:a.id,label:a.name,value:a.id},{default:n(()=>[t("div",Ce,[t("span",null,c(a.name),1),t("span",Te,"¥"+c(a.price)+"/晚",1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,{label:"房间数量",prop:"roomCount"},{default:n(()=>[s(B,{modelValue:o.roomCount,"onUpdate:modelValue":e[3]||(e[3]=a=>o.roomCount=a),min:1,max:5,"controls-position":"right",class:"custom-number",onChange:$},null,8,["modelValue"])]),_:1}),e[26]||(e[26]=t("h3",{class:"form-section-title"},"联系人信息",-1)),s(r,{label:"联系人",prop:"contactName"},{default:n(()=>[s(I,{modelValue:o.contactName,"onUpdate:modelValue":e[4]||(e[4]=a=>o.contactName=a),placeholder:"请输入联系人姓名",class:"custom-input"},null,8,["modelValue"])]),_:1}),s(r,{label:"手机号码",prop:"phone"},{default:n(()=>[s(I,{modelValue:o.phone,"onUpdate:modelValue":e[5]||(e[5]=a=>o.phone=a),placeholder:"请输入手机号码",class:"custom-input"},null,8,["modelValue"])]),_:1}),s(r,{label:"备注"},{default:n(()=>[s(I,{modelValue:o.remarks,"onUpdate:modelValue":e[6]||(e[6]=a=>o.remarks=a),type:"textarea",placeholder:"如有特殊要求请在此说明",rows:3,class:"custom-textarea"},null,8,["modelValue"])]),_:1}),u.value?(i(),m("div",Ve,[t("div",we,[e[11]||(e[11]=t("span",{class:"level-label"},"会员等级:",-1)),t("span",{class:ke(["level-value","level-"+h.value.toLowerCase().replace("会员","")])},c(h.value),3),D()<1?(i(),m("span",xe," （享"+c(D()*10)+"折优惠） ",1)):v("",!0)])])):v("",!0),e[27]||(e[27]=t("h3",{class:"form-section-title"},"付款方式",-1)),s(r,{label:"支付方式",prop:"paymentMethod"},{default:n(()=>[s(G,{modelValue:o.paymentMethod,"onUpdate:modelValue":e[7]||(e[7]=a=>o.paymentMethod=a)},{default:n(()=>[s(T,{label:1},{default:n(()=>e[12]||(e[12]=[k("在线支付")])),_:1}),s(T,{label:2,disabled:!q.value},{default:n(()=>[e[13]||(e[13]=k(" 到店支付 ")),q.value?v("",!0):(i(),m("span",Me,"（铜牌及以上会员专享）"))]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),o.paymentMethod===1?(i(),F(r,{key:1,label:"预付金额"},{default:n(()=>[s(G,{modelValue:o.depositType,"onUpdate:modelValue":e[8]||(e[8]=a=>o.depositType=a),onChange:Z},{default:n(()=>[s(T,{label:1},{default:n(()=>e[14]||(e[14]=[k("全额支付")])),_:1}),s(T,{label:2},{default:n(()=>e[15]||(e[15]=[k("预付30%")])),_:1}),s(T,{label:3,disabled:!P.value},{default:n(()=>[e[16]||(e[16]=k(" 免预付金 ")),P.value?v("",!0):(i(),m("span",Se,"（银牌及以上会员专享）"))]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1})):v("",!0),t("div",Ne,[t("div",De,[e[17]||(e[17]=t("span",null,"房间单价:",-1)),t("span",null,"¥"+c(S.value),1)]),t("div",Oe,[e[18]||(e[18]=t("span",null,"入住天数:",-1)),t("span",null,c(N.value)+"晚",1)]),t("div",Ae,[e[19]||(e[19]=t("span",null,"房间数量:",-1)),t("span",null,c(o.roomCount)+"间",1)]),u.value&&O.value>0?(i(),m("div",Be,[e[20]||(e[20]=t("span",null,"会员折扣:",-1)),t("span",Le,"-¥"+c(O.value.toFixed(2)),1)])):v("",!0),t("div",Fe,[e[21]||(e[21]=t("span",null,"订单总额:",-1)),t("span",null,"¥"+c(b.value.toFixed(2)),1)]),o.paymentMethod===1?(i(),m("div",Ue,[e[22]||(e[22]=t("span",null,"预付金额:",-1)),t("span",Pe,"¥"+c(Y.value.toFixed(2)),1)])):v("",!0),u.value&&R.value>0?(i(),m("div",qe,[e[23]||(e[23]=t("span",null,"预计积分:",-1)),t("span",Re,"+"+c(R.value),1)])):v("",!0)]),s(r,{class:"form-actions"},{default:n(()=>[s(p,{type:"primary",onClick:oe,class:"submit-btn",loading:M.value},{default:n(()=>[k(c(o.paymentMethod===1?"立即支付":"提交预订"),1)]),_:1},8,["loading"]),s(p,{onClick:J,class:"reset-btn"},{default:n(()=>e[24]||(e[24]=[k("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t("div",$e,[u.value?(i(),m("div",Ee,e[30]||(e[30]=[t("i",{class:"el-icon-medal"},null,-1),t("span",null,"会员专享9折优惠",-1)]))):v("",!0),u.value?(i(),m("div",ze,e[31]||(e[31]=[t("i",{class:"el-icon-present"},null,-1),t("span",null,"预订即可获得积分奖励",-1)]))):(i(),m("div",He,e[32]||(e[32]=[t("i",{class:"el-icon-check"},null,-1),t("span",null,"注册会员享更多优惠",-1)]))),t("div",je,[e[33]||(e[33]=t("i",{class:"el-icon-check"},null,-1)),t("span",null,c(u.value?"会员可免费取消":"提前24小时取消免费"),1)]),e[34]||(e[34]=t("div",{class:"benefit-item"},[t("i",{class:"el-icon-check"}),t("span",null,"最优价格保证")],-1))])])])}}},Qe=re(Je,[["__scopeId","data-v-f8ab7fd6"]]);export{Qe as default};
